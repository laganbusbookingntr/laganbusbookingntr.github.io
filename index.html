<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lagan Bus Booking ‚Äî Check Your Seat</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
:root{
  --blue:#3a7bd5;
  --blue2:#67b8f7;
  --blue-dark:#1a5cb0;
  --muted:#66788A;
  --border:#dce4ec;
  --accent:#0f6fb1;
  --success:#10b981;
  --danger:#ef4444;
  --light-body-bg: linear-gradient(135deg, #f5f7fa 0%, #eef3f8 100%);
  --dark-body-bg: linear-gradient(180deg,#05060a 0%, #071428 100%);
}

/* Basic reset + layout */
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI', system-ui, -apple-system, sans-serif}
html,body{height:100%}
body{
  background:var(--light-body-bg);
  color:#0b2638;
  transition:background .35s, color .35s;
  padding:18px;
  display:flex;
  justify-content:center;
}

/* container width limit */
.container{
  width:100%;
  max-width:960px;
  display:flex;
  flex-direction:column;
  gap:10px;
  align-items:stretch;
}

/* SKY */
.sky-container{
  width:100%;
  height:150px;
  border-radius:12px;
  position:relative;
  overflow:hidden;
  background:linear-gradient(180deg,#bfe4ff,#eaf6ff);
  transition:background .6s ease;
}

/* sun/moon/clouds/stars */
.sun{ width:72px;height:72px;border-radius:50%; background:#FFD93D; position:absolute; left:28px; bottom:-20px; box-shadow:0 0 32px rgba(255,217,61,0.85); transform-origin:center; animation:sunFloat 6s ease-in-out infinite; transition:opacity .4s; }
@keyframes sunFloat{0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)}}
.moon{ width:56px;height:56px;border-radius:50%; background:linear-gradient(180deg,#fff,#f2f2f2); position:absolute; right:40px; top:24px; box-shadow:0 0 18px rgba(255,255,255,0.18); opacity:0; transition:opacity .45s; }
.cloud{ position:absolute; width:84px;height:36px;background:#fff;border-radius:40px; box-shadow:28px 12px 0 #fff,50px 18px 0 #fff; opacity:0.95; transition:opacity .45s; }
.c1{ top:25px; left:-160px; animation: cloudMove 28s linear infinite; }
.c2{ top:45px; left:8%; transform:scale(1.05); animation: cloudMove 30s linear infinite; animation-delay:-7s; }
.c3{ top:58px; left:60%; transform:scale(0.92); animation: cloudMove 34s linear infinite; animation-delay:-14s; }
.c4{ top:35px; left:82%; transform:scale(1.05); animation: cloudMove 28s linear infinite; animation-delay:-20s; }
@keyframes cloudMove{0%{left:-160px}100%{left:120%}}
.stars{ position:absolute; inset:0; background:
    radial-gradient(1.5px 1.5px at 20% 30%, rgba(255,255,255,0.95), transparent),
    radial-gradient(1.5px 1.5px at 60% 50%, rgba(255,255,255,0.85), transparent),
    radial-gradient(1.2px 1.2px at 80% 40%, rgba(255,255,255,0.8), transparent);
  opacity:0; transition:opacity .5s; pointer-events:none; }
.shooting-star{ position:absolute;width:3px;height:3px;border-radius:50%; background:white; top:20px; left:-120px; opacity:0; }

/* small toolbar inside sky (right) */
.mode-toggle{ position:absolute; right:14px; top:12px; display:flex; gap:8px; background:rgba(255,255,255,0.9); padding:6px; border-radius:999px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
.mode-btn{ border:0; background:transparent; padding:6px; cursor:pointer; font-size:16px; border-radius:999px; }
.mode-btn.active{ background:linear-gradient(90deg,#fff,#eef6ff); }

/* CARD area */
.card-wrap{ display:flex; gap:16px; align-items:flex-start; }

/* left column - small card */
.left-col{ width:260px; flex:0 0 260px; display:flex; gap:12px; flex-direction:column; }
.header{
  background:rgba(255,255,255,0.95); border-radius:12px; padding:14px; box-shadow:0 8px 22px rgba(0,0,0,0.04);
}
.brand{ font-weight:800; color:var(--blue-dark); font-size:20px; margin-bottom:6px; line-height:1; }
.welcome{ color:#444; font-weight:600; margin-bottom:8px; }
.sub{ background:rgba(58,123,213,0.06); padding:8px 12px; border-radius:999px; display:inline-block; color:var(--muted); font-weight:700; }

/* form card */
.form-card{ background:#fff; padding:16px; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,0.04); }
.input{ width:100%; padding:12px; border-radius:10px; border:2px solid #e6edf5; font-size:15px; background:#fbfdff; }
.btn{ width:100%; margin-top:12px; padding:12px; border-radius:10px; border:0; background:linear-gradient(135deg,var(--blue2),var(--blue)); color:white; font-weight:800; cursor:pointer; }

/* right column - main ticket output */
.right-col{ flex:1; }
.ticket{ display:none; background:linear-gradient(180deg,#fff,#f8fbff); border-radius:12px; padding:18px; border:1px solid rgba(26,92,176,0.06); box-shadow:0 12px 40px rgba(11,86,141,0.04); }
.ticket-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px 18px; }
.ticket-row{ background: rgba(255,255,255,0.6); padding:10px 12px; border-radius:8px; border:1px solid rgba(10,80,150,0.03); }
.ticket-label{ font-size:11px; color:var(--muted); font-weight:800; text-transform:uppercase; }
.ticket-value{ font-size:16px; font-weight:900; color:#0c1b2a; margin-top:6px; }

/* seats */
.seat-pill{ display:inline-block; padding:8px 12px; border-radius:999px; background:#eaf6ff; border:1px solid rgba(15,111,177,0.12); margin:6px 6px 6px 0; font-weight:900; }

/* footer */
.footer{ text-align:center; color:#8b9aad; margin-top:12px; }

/* Dark mode */
body.dark{ background:var(--dark-body-bg); color:#dfefff; }
body.dark .sky-container{ background:linear-gradient(180deg,#071428,#020412); box-shadow:inset 0 -20px 40px rgba(0,0,0,0.25); }
body.dark .sun{ opacity:0; transform:translateY(6px) scale(.95); }
body.dark .moon{ opacity:1; }
body.dark .cloud{ opacity:0.18; filter:blur(1px); }
body.dark .stars{ opacity:1; }
body.dark .header, body.dark .form-card{ background:rgba(8,12,20,0.5); color:#eaf6ff; border:1px solid rgba(255,255,255,0.02); box-shadow:none; }
body.dark .ticket{ background:linear-gradient(180deg,#071428,#041223); color:#e6f5ff; border:1px solid rgba(255,255,255,0.03); box-shadow:none; }
body.dark .ticket-row{ background:rgba(255,255,255,0.02); }

/* small screens */
@media (max-width:880px){
  .card-wrap{ flex-direction:column; }
  .left-col{ width:100%; flex:0 0 auto; order:2; }
  .right-col{ order:1; }
  .mode-toggle{ right:8px; top:8px; }
}
</style>
</head>
<body>
<div class="container">

  <!-- SKY -->
  <div class="sky-container sky-day" id="sky" aria-hidden="true">
    <div class="sun" id="sun" aria-hidden="true"></div>
    <div class="moon" id="moon" aria-hidden="true"></div>

    <div class="cloud c1" aria-hidden="true"></div>
    <div class="cloud c2" aria-hidden="true"></div>
    <div class="cloud c3" aria-hidden="true"></div>
    <div class="cloud c4" aria-hidden="true"></div>

    <div class="stars" id="stars" aria-hidden="true"></div>
    <div class="shooting-star" id="shooting" aria-hidden="true"></div>

    <div class="mode-toggle" role="toolbar" aria-label="Theme toggle">
      <button id="dayBtn" class="mode-btn" title="Day mode">‚òÄÔ∏è</button>
      <button id="nightBtn" class="mode-btn" title="Night mode">üåô</button>
    </div>
  </div>

  <!-- MAIN CARDS -->
  <div class="card-wrap">
    <div class="left-col">
      <div class="header">
        <div class="brand">Welcome To Lagan Bus Booking</div>
        <div class="welcome">Safe Travels. May God Bless Your Journey.</div>
        <div class="sub">For Reservations: <strong>0777 402 886 (Mr. Fawas)</strong></div>
      </div>

      <div class="form-card">
        <input id="phone" class="input" placeholder="Enter phone number (077XXXXXXX)" inputmode="tel" maxlength="10" />
        <button id="searchBtn" class="btn">üîç Check My Booking</button>
      </div>
    </div>

    <div class="right-col">
      <div id="box" class="ticket" aria-live="polite" role="region">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div>
            <div style="font-weight:900;color:var(--blue-dark)">üé´ Lagan Bus</div>
            <div style="font-size:12px;color:var(--muted);font-weight:700">Premium Boarding Pass</div>
          </div>
          <div style="text-align:right">
            <div id="ticketRef" style="font-weight:800;color:var(--accent)">‚Äî</div>
            <div id="issuedAt" style="font-size:11px;color:var(--muted);margin-top:6px">Issued</div>
          </div>
        </div>

        <div class="ticket-grid">
          <div class="ticket-row">
            <div class="ticket-label">Passenger</div>
            <div id="passengerName" class="ticket-value">-</div>
          </div>
          <div class="ticket-row">
            <div class="ticket-label">Bus</div>
            <div id="busName" class="ticket-value">-</div>
          </div>
          <div class="ticket-row">
            <div class="ticket-label">Date & Time</div>
            <div id="dateTime" class="ticket-value">-</div>
          </div>
          <div class="ticket-row">
            <div class="ticket-label">Pickup</div>
            <div id="pickupLocation" class="ticket-value">-</div>
          </div>
          <div class="ticket-row">
            <div class="ticket-label">Payment</div>
            <div id="paymentAmount" class="ticket-value">-</div>
          </div>

          <div class="ticket-row" style="grid-column:1 / -1">
            <div class="ticket-label">Seat Numbers</div>
            <div id="seatsBox" style="margin-top:8px"></div>
          </div>
        </div>

        <button id="printBtn" class="btn" style="margin-top:12px">üñ®Ô∏è Print My Ticket</button>

        <div id="feedbackBox" style="margin-top:12px;display:none">
          <div style="font-weight:700;color:var(--blue-dark);margin-bottom:10px">Did you get your seat number correctly?</div>
          <div style="display:flex;gap:12px">
            <button class="btn" onclick="sendFeedback('Yes')" style="flex:1;background:#e8f5e9;color:#256029;border:1px solid rgba(10,120,60,0.08)">üëç Yes</button>
            <button class="btn" onclick="sendFeedback('No')" style="flex:1;background:#ffebee;color:#9b1f1f;border:1px solid rgba(120,10,10,0.06)">üëé No</button>
          </div>
        </div>
      </div>

      <div class="footer" style="margin-top:12px">Made with <span style="color:#e74c3c">‚ù§</span> by <strong style="color:var(--blue)">WEDOXA</strong></div>
    </div>
  </div>
</div>

<!-- All JS must be inside this script tag. Do NOT paste JS outside it. -->
<script>
/* ===================== CONFIG ===================== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwKWNQcXnjjzh540oJWgZJsJi1wQMd0PS94pjiHXy7VjlrR95ME2xnveTuDhPvlZScdow/exec";

/* ===================== Helpers ===================== */
function isIsoString(s){ return typeof s==='string' && /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(s); }
function tryParseDate(val){
  if (val === null || val === undefined || val === '') return null;
  if (Object.prototype.toString.call(val) === '[object Date]') return val;
  if (typeof val === 'number') { const d = new Date(val); if (!isNaN(d)) return d; }
  if (typeof val === 'string' && isIsoString(val)) { const d = new Date(val); if (!isNaN(d)) return d; }
  try { const d = new Date(val); if (!isNaN(d)) return d; } catch(e){}
  if (typeof val === 'string' && /^\d{1,2}\/\d{1,2}\/\d{2,4}/.test(val)){
    const p = val.split('/'); const d = new Date(+p[2], +p[1]-1, +p[0]); if (!isNaN(d)) return d;
  }
  return null;
}
function formatDateTimeForColombo(dateObj){
  if (!dateObj) return { dateStr:'-', timeStr:'-' };
  try {
    const dateOptions = { day:'numeric', month:'short', year:'numeric', timeZone:'Asia/Colombo' };
    const timeOptions = { hour:'numeric', minute:'2-digit', hour12:true, timeZone:'Asia/Colombo' };
    return {
      dateStr: new Intl.DateTimeFormat('en-GB', dateOptions).format(dateObj),
      timeStr: new Intl.DateTimeFormat('en-GB', timeOptions).format(dateObj)
    };
  } catch(e){
    const d = new Date(dateObj.getTime() + (dateObj.getTimezoneOffset()*60000));
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return { dateStr: `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`, timeStr: `${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}` };
  }
}
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

function getField(obj, candidates){
  if (!obj) return null;
  const keys = Object.keys(obj||{});
  const norm = k => k.toString().toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9]/g,'');
  const map = {}; keys.forEach(k => map[norm(k)] = k);
  for (let c of candidates){
    const found = map[norm(c)]; if (found) return obj[found];
  }
  if (keys.length) return obj[keys[0]];
  return null;
}

/* ===================== UI init ===================== */
document.addEventListener('DOMContentLoaded', ()=> {
  const phone = document.getElementById('phone');
  phone.addEventListener('input', e => { let v = e.target.value.replace(/\D/g,''); if (v.length>10) v=v.slice(0,10); e.target.value=v; });
  phone.addEventListener('keypress', e => { if (e.key==='Enter') searchBooking(); });

  document.getElementById('searchBtn').addEventListener('click', searchBooking);
  document.getElementById('printBtn').addEventListener('click', printTicket);
  document.getElementById('dayBtn').addEventListener('click', ()=> setMode('light'));
  document.getElementById('nightBtn').addEventListener('click', ()=> setMode('dark'));

  // restore mode
  const saved = localStorage.getItem('lagan-mode') || 'light';
  setMode(saved, true);

  // small random shooting star in dark mode
  setInterval(()=> {
    const s = document.getElementById('shooting');
    if (!s) return;
    if (Math.random() < 0.08 && document.body.classList.contains('dark')) {
      s.style.opacity='1';
      s.animate([{transform:'translateX(0)'},{transform:'translateX(720px)'}], {duration:1400, easing:'cubic-bezier(.2,.8,.2,1)'});
      setTimeout(()=> s.style.opacity='0', 1400);
    }
  }, 2800);
});

/* ===================== Mode toggle ===================== */
function setMode(m, instant=false){
  const mode = (m === 'dark') ? 'dark' : 'light';
  if (mode === 'dark'){
    document.body.classList.add('dark');
    document.getElementById('sky').classList.remove('sky-day'); // CSS uses .sky-container base
    document.querySelectorAll('.cloud').forEach(c => c.style.opacity='0.18');
    document.getElementById('sun').style.opacity='0';
    document.getElementById('moon').style.opacity='1';
    document.getElementById('stars').style.opacity='1';
    document.getElementById('nightBtn').classList.add('active');
    document.getElementById('dayBtn').classList.remove('active');
  } else {
    document.body.classList.remove('dark');
    document.getElementById('sky').classList.add('sky-day');
    document.querySelectorAll('.cloud').forEach(c => c.style.opacity='0.95');
    document.getElementById('sun').style.opacity='1';
    document.getElementById('moon').style.opacity='0';
    document.getElementById('stars').style.opacity='0';
    document.getElementById('dayBtn').classList.add('active');
    document.getElementById('nightBtn').classList.remove('active');
  }
  localStorage.setItem('lagan-mode', mode);
}

/* ===================== Booking lookup ===================== */
function searchBooking(){
  const phone = document.getElementById('phone').value.trim();
  const btn = document.getElementById('searchBtn');
  if (!phone || phone.length < 9) {
    Swal.fire({ icon:'warning', title:'Enter Phone Number', text:'Please enter a valid 10-digit phone number', confirmButtonColor:'#3a7bd5' });
    return;
  }
  btn.innerHTML = '<div style="display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 1s linear infinite;margin-right:8px;"></div> Searching...';
  btn.disabled = true;
  Swal.fire({ title:'Finding your booking...', allowOutsideClick:false, didOpen: ()=> Swal.showLoading() });

  fetch(`${SCRIPT_URL}?phone=${encodeURIComponent(phone)}`)
    .then(r => r.json())
    .then(data => {
      btn.innerHTML = 'üîç Check My Booking'; btn.disabled = false; Swal.close();
      if (!data.success) { Swal.fire({ icon:'error', title:'No Booking Found', text:'We could not find a booking with this phone number', confirmButtonColor:'#3a7bd5'}); return; }
      renderBooking(data.booking);
    })
    .catch(err => {
      btn.innerHTML = 'üîç Check My Booking'; btn.disabled = false; Swal.close();
      Swal.fire({ icon:'error', title:'Connection Error', text:'Please check your internet connection and try again', confirmButtonColor:'#3a7bd5' });
      console.error(err);
    });
}

/* ===================== Render booking ===================== */
function renderBooking(b){
  console.log('booking', b);
  const passenger = getField(b, ['Passenger Name','Passenger','Name','Full Name','Pax']);
  const bus = getField(b, ['Bus','Bus Name','Route','Service']);
  const dateField = getField(b, ['Date','Travel Date','Departure Date','Journey Date','DateTime','Date/Time']);
  const timeField = getField(b, ['Time','Departure Time','Time','Departure']);
  const seatField = getField(b, ['Seat','Seats','Seat Number','Seat Numbers','SeatNo']);
  const pickup = getField(b, ['Pickup','Pickup Location','Boarding','Boarding Point']);
  const payment = getField(b, ['Payment','Amount','Payment Status']);
  const ref = getField(b, ['Reference','Ref','BookingID','BookingRef','Booking ID']);

  document.getElementById('passengerName').textContent = passenger || '-';
  document.getElementById('busName').textContent = bus || '-';

  // date parsing
  let finalDate = null;
  if (dateField) finalDate = tryParseDate(dateField);
  if (!finalDate && timeField) finalDate = tryParseDate(timeField);
  if (!finalDate && isIsoString(seatField)) finalDate = tryParseDate(seatField);
  const fmt = formatDateTimeForColombo(finalDate);
  const dateTimeText = (fmt.dateStr && fmt.dateStr !== 'Invalid Date') ? `${fmt.dateStr} ‚Ä¢ ${fmt.timeStr}` : '-';
  document.getElementById('dateTime').textContent = dateTimeText;

  document.getElementById('pickupLocation').textContent = pickup || '-';
  const paymentEl = document.getElementById('paymentAmount');
  paymentEl.textContent = payment || '-';
  if (payment && String(payment).toLowerCase().includes('paid')) {
    paymentEl.innerHTML = `${escapeHtml(String(payment))} <span style="margin-left:8px;padding:4px 8px;border-radius:999px;background:#e8f5e9;color:#2e7d32;font-weight:800;font-size:11px;">Paid</span>`;
  }

  document.getElementById('ticketRef').textContent = ref ? `Ref: ${ref}` : 'Ref: ‚Äî';
  document.getElementById('issuedAt').textContent = `Issued: ${new Date().toLocaleString()}`;

  // seats
  const seatsBox = document.getElementById('seatsBox'); seatsBox.innerHTML = '';
  const seatVal = seatField || '';
  if (seatVal && String(seatVal).trim().toLowerCase() !== 'not updated') {
    const seats = String(seatVal).split(/[,;\/\s]+/).filter(s => s.trim() !== '');
    if (seats.length) {
      seats.forEach(s => { const sp = document.createElement('span'); sp.className='seat-pill'; sp.textContent = s.trim(); seatsBox.appendChild(sp); });
    } else seatsBox.innerHTML = '<div style="color:#666;font-style:italic;">No seat assigned</div>';
  } else seatsBox.innerHTML = '<div style="color:#666;font-style:italic;">No seat assigned</div>';

  document.getElementById('box').style.display = 'block';
  document.getElementById('feedbackBox').style.display = 'block';
  setTimeout(()=> document.getElementById('box').scrollIntoView({behavior:'smooth', block:'start'}), 240);
}

/* ===================== Print ===================== */
function printTicket(){
  const box = document.getElementById('box');
  if (!box || box.style.display === 'none') return;
  const html = `
  <html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Ticket</title>
  <style>body{font-family:'Segoe UI',sans-serif;padding:18px;background:#fff;color:#071428} .ticket{max-width:700px;margin:0 auto;border-radius:12px;padding:18px;border:1px dashed #cfe8ff} .label{font-size:11px;color:#5f6f82;text-transform:uppercase;font-weight:800} .value{font-size:16px;font-weight:900;margin-top:6px;color:#0b2638} .seat{display:inline-block;padding:8px 12px;border-radius:999px;background:#eaf6ff;margin:6px 6px 6px 0;font-weight:800;border:1px solid rgba(15,111,177,0.12)}</style>
  </head><body>
    <div class="ticket">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><div style="font-weight:900;color:#0f6fb1">üé´ Lagan Bus</div><div style="font-weight:700;color:#6b7f92">Premium Boarding Pass</div></div>
        <div style="text-align:right"><div style="font-weight:800;color:#0f6fb1">${escapeHtml(document.getElementById('ticketRef').textContent)}</div><div style="font-size:12px;color:#6b7f92;margin-top:6px">${escapeHtml(document.getElementById('issuedAt').textContent)}</div></div>
      </div>
      <hr style="border:none;border-top:1px dashed rgba(0,0,0,0.06);margin:12px 0;">
      <div style="margin-bottom:10px;"><div class="label">Passenger</div><div class="value">${escapeHtml(document.getElementById('passengerName').textContent)}</div></div>
      <div style="display:flex;gap:12px;margin-bottom:10px"><div style="flex:1"><div class="label">Bus</div><div class="value">${escapeHtml(document.getElementById('busName').textContent)}</div></div><div style="flex:1"><div class="label">Date & Time</div><div class="value">${escapeHtml(document.getElementById('dateTime').textContent)}</div></div></div>
      <div style="margin-bottom:10px"><div class="label">Pickup</div><div class="value">${escapeHtml(document.getElementById('pickupLocation').textContent)}</div></div>
      <div style="margin-bottom:10px"><div class="label">Payment</div><div class="value">${escapeHtml(document.getElementById('paymentAmount').textContent)}</div></div>
      <div style="margin-bottom:10px"><div class="label">Seats</div><div style="margin-top:8px">${[...document.querySelectorAll('#seatsBox .seat-pill')].map(n=>`<span class="seat">${escapeHtml(n.textContent)}</span>`).join('') || '<span style="color:#666;font-style:italic;">No seat assigned</span>'}</div></div>
    </div>
    <script>window.onload=function(){ setTimeout(()=>{ window.print(); },200);}<\/script>
  </body></html>`;
  const w = window.open('','_blank','noopener');
  if (!w) { Swal.fire({ icon:'error', title:'Popup Blocked', text:'Please allow popups to print the ticket.' }); return; }
  w.document.open(); w.document.write(html); w.document.close();
}

/* ===================== Feedback ===================== */
function sendFeedback(answer){
  const phone = document.getElementById('phone').value.trim();
  const box = document.getElementById('feedbackBox');
  const original = box.innerHTML;
  box.innerHTML = `<div style="text-align:center;padding:10px;"><div style="display:inline-block;width:18px;height:18px;border:2px solid rgba(0,0,0,0.08);border-top-color:#3a7bd5;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:8px"></div><div>Sending feedback...</div></div>`;
  fetch(`${SCRIPT_URL}?action=feedback&phone=${encodeURIComponent(phone)}&answer=${encodeURIComponent(answer)}`)
    .then(r=>r.json()).then(data=>{
      if (data.success) {
        box.style.opacity='0'; box.style.transition='opacity .3s'; setTimeout(()=>{ box.style.display='none'; box.innerHTML = original; },320);
        Swal.fire({ icon:'success', title:'Thank You!', text:'Your feedback has been recorded.', timer:1400, showConfirmButton:false, confirmButtonColor:'#3a7bd5' });
      } else { box.innerHTML = original; Swal.fire({ icon:'error', title:'Failed', text:'Could not send feedback. Please try again.' }); }
    }).catch(err => { box.innerHTML = original; Swal.fire({ icon:'error', title:'Error', text:'Please check your connection and try again.' }); });
}
</script>
</body>
</html>
